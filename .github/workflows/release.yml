name: release

on:
  workflow_dispatch:

env:
  APPLICATION_NAME: upscayl-bin
  VK_VERSION: 1.3.280.0
  MOLTEN_VK_INCLUDE_PATH: macOS/include
  MOLTEN_VK_LIB_PATH: macOS/lib/MoltenVK.xcframework/macos-arm64_x86_64/libMoltenVK.a

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      APPNAME: ${{ steps.app.outputs.APPNAME }}
      VERSION: ${{ steps.ver.outputs.VERSION }}
    steps:
      - id: app
        run: echo "APPNAME=${APPLICATION_NAME}" >> "$GITHUB_OUTPUT"
      - id: ver
        run: echo "VERSION=$(date +'%Y%m%d-%H%M%S')" >> "$GITHUB_OUTPUT"

  # ---------------- Linux ----------------
  ubuntu:
    needs: setup
    runs-on: ubuntu-22.04
    env:
      PACKAGENAME: ${{ needs.setup.outputs.APPNAME }}-${{ needs.setup.outputs.VERSION }}-linux
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Vulkan SDK
        run: |
          wget https://sdk.lunarg.com/sdk/download/${VK_VERSION}/linux/vulkansdk-linux-x86_64-${VK_VERSION}.tar.xz?Human=true -O vk.tar.xz
          tar xf vk.tar.xz
          rm -rf ${VK_VERSION}/source ${VK_VERSION}/samples

      - name: Build
        run: |
          sudo apt update
          sudo apt install -y gcc-9 g++-9
          export CC=gcc-9 CXX=g++-9
          export VULKAN_SDK=$(pwd)/${VK_VERSION}/x86_64
          mkdir build && cd build
          cmake ../src
          cmake --build . -j2

      - name: Package
        run: |
          mkdir $PACKAGENAME
          cp README.md LICENSE build/${{ needs.setup.outputs.APPNAME }} $PACKAGENAME
          strip $PACKAGENAME/${{ needs.setup.outputs.APPNAME }}
          zip -9r $PACKAGENAME.zip $PACKAGENAME

      - uses: actions/upload-artifact@v4
        with:
          name: $PACKAGENAME
          path: $PACKAGENAME.zip

  # ---------------- macOS x86_64 ----------------
  macos-x86:
    needs: setup
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Dependencies
        run: brew install libomp glslang

      - name: Vulkan SDK
        run: |
          curl -L -o vk.dmg "https://sdk.lunarg.com/sdk/download/${VK_VERSION}/mac/vulkansdk-macos-${VK_VERSION}.dmg?Human=true"
          hdiutil attach vk.dmg -quiet
          sudo /Volumes/vulkansdk-macos-${VK_VERSION}/InstallVulkan.app/Contents/MacOS/InstallVulkan \
            --root $(pwd)/vulkan-mac-sdk --accept-licenses --default-answer --confirm-command install
          hdiutil detach /Volumes/vulkansdk-macos-${VK_VERSION} -quiet

      - name: Build x86_64
        run: |
          LIBOMP=$(brew --prefix libomp)
          mkdir build && cd build
          cmake ../src \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DUSE_STATIC_MOLTENVK=ON \
            -DOpenMP_C_FLAGS="-Xclang -fopenmp -I$LIBOMP/include" \
            -DOpenMP_CXX_FLAGS="-Xclang -fopenmp -I$LIBOMP/include" \
            -DOpenMP_C_LIB_NAMES=omp \
            -DOpenMP_CXX_LIB_NAMES=omp \
            -DOpenMP_libomp_LIBRARY="$LIBOMP/lib/libomp.a" \
            -DVulkan_INCLUDE_DIR=$(pwd)/../vulkan-mac-sdk/${MOLTEN_VK_INCLUDE_PATH} \
            -DVulkan_LIBRARY=$(pwd)/../vulkan-mac-sdk/${MOLTEN_VK_LIB_PATH}
          cmake --build . -j4

      - uses: actions/upload-artifact@v4
        with:
          name: macos-x86
          path: build/${{ needs.setup.outputs.APPNAME }}

  # ---------------- macOS arm64 ----------------
  macos-arm:
    needs: setup
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Dependencies
        run: brew install libomp glslang

      - name: Vulkan SDK
        run: |
          curl -L -o vk.dmg "https://sdk.lunarg.com/sdk/download/${VK_VERSION}/mac/vulkansdk-macos-${VK_VERSION}.dmg?Human=true"
          hdiutil attach vk.dmg -quiet
          sudo /Volumes/vulkansdk-macos-${VK_VERSION}/InstallVulkan.app/Contents/MacOS/InstallVulkan \
            --root $(pwd)/vulkan-mac-sdk --accept-licenses --default-answer --confirm-command install
          hdiutil detach /Volumes/vulkansdk-macos-${VK_VERSION} -quiet

      - name: Build arm64
        run: |
          LIBOMP=$(brew --prefix libomp)
          mkdir build && cd build
          cmake ../src \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DUSE_STATIC_MOLTENVK=ON \
            -DOpenMP_C_FLAGS="-Xclang -fopenmp -I$LIBOMP/include" \
            -DOpenMP_CXX_FLAGS="-Xclang -fopenmp -I$LIBOMP/include" \
            -DOpenMP_C_LIB_NAMES=omp \
            -DOpenMP_CXX_LIB_NAMES=omp \
            -DOpenMP_libomp_LIBRARY="$LIBOMP/lib/libomp.a" \
            -DVulkan_INCLUDE_DIR=$(pwd)/../vulkan-mac-sdk/${MOLTEN_VK_INCLUDE_PATH} \
            -DVulkan_LIBRARY=$(pwd)/../vulkan-mac-sdk/${MOLTEN_VK_LIB_PATH}
          cmake --build . -j4

      - uses: actions/upload-artifact@v4
        with:
          name: macos-arm
          path: build/${{ needs.setup.outputs.APPNAME }}

  # ---------------- macOS Universal ----------------
  macos-universal:
    needs: [setup, macos-x86, macos-arm]
    runs-on: macos-14
    env:
      PACKAGENAME: ${{ needs.setup.outputs.APPNAME }}-${{ needs.setup.outputs.VERSION }}-macos
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Universal Binary
        run: |
          mkdir $PACKAGENAME
          cp README.md LICENSE $PACKAGENAME
          lipo -create \
            artifacts/macos-x86/${{ needs.setup.outputs.APPNAME }} \
            artifacts/macos-arm/${{ needs.setup.outputs.APPNAME }} \
            -o $PACKAGENAME/${{ needs.setup.outputs.APPNAME }}
          strip $PACKAGENAME/${{ needs.setup.outputs.APPNAME }}
          zip -9r $PACKAGENAME.zip $PACKAGENAME

      - uses: actions/upload-artifact@v4
        with:
          name: $PACKAGENAME
          path: $PACKAGENAME.zip

  # ---------------- Windows ----------------
  windows:
    needs: setup
    runs-on: windows-latest
    env:
      PACKAGENAME: ${{ needs.setup.outputs.APPNAME }}-${{ needs.setup.outputs.VERSION }}-windows
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Vulkan SDK
        run: |
          Invoke-WebRequest https://sdk.lunarg.com/sdk/download/${env:VK_VERSION}/windows/VulkanSDK-${env:VK_VERSION}-Installer.exe?Human=true -OutFile vk.exe
          7z x vk.exe -oVulkanSDK

      - name: Build
        run: |
          $env:VULKAN_SDK="$(pwd)/VulkanSDK"
          mkdir build; cd build
          cmake -A x64 ../src
          cmake --build . --config Release

      - name: Package
        run: |
          mkdir $env:PACKAGENAME
          Copy-Item README.md,LICENSE build/Release/${{ needs.setup.outputs.APPNAME }}.exe $env:PACKAGENAME
          7z a $env:PACKAGENAME.zip $env:PACKAGENAME

      - uses: actions/upload-artifact@v4
        with:
          name: $env:PACKAGENAME
          path: $env:PACKAGENAME.zip

  # ---------------- GitHub Release ----------------
  release:
    needs: [ubuntu, macos-universal, windows, setup]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.setup.outputs.VERSION }}
          name: upscayl-bin-${{ needs.setup.outputs.VERSION }}
          files: artifacts/**/**/*.zip
